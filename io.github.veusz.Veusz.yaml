app-id: io.github.veusz.Veusz
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
command: veusz
separate-locales: false
rename-desktop-file: veusz.desktop
rename-icon: veusz
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri

cleanup:
  - /include
  - /share/doc
  - /share/hdf5_examples
  - /share/man
  - /share/sip
  - "*.la"
  - "*.a"

modules:
  - name: python-numpy
    buildsystem: simple
    build-commands:
      - rm pyproject.toml
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: git
        url: https://github.com/numpy/numpy
        tag: v1.20.2
        commit: b19ad5bfa396a4600a52a598a30a65d4e993f831
        
  - name: python-pkgconfig
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/ae/61/5a76ead90f9a62212c231b05231031e750f24e4dd2401d8c7f3f0527821b/pkgconfig-1.5.2.tar.gz
        sha256: 38d612488f0633755a2e7a8acab6c01d20d63dbc31af75e2a9ac98a6f638ca94
        
  - name: python3-packaging
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/86/3c/bcd09ec5df7123abcf695009221a52f90438d877a2f1499453c6938f5728/packaging-20.9.tar.gz
        sha256: 5b327ac1320dc863dca72f4514ecc086f31186744b84a230374cc1fd776feae5
        
  - name: python3-Pyparsing
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://github.com/pyparsing/pyparsing/releases/download/pyparsing_2.4.7/pyparsing-2.4.7.tar.gz
        sha256: c203ec8783bf771a155b207279b9bccb8dea02d8f0c9e5f8ead507bc3246ecc1
        
  - name: python3-toml
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://github.com/uiri/toml/archive/refs/tags/0.10.2.tar.gz
        sha256: 71d4039bbdec91e3e7591ec5d6c943c58f9a2d17e5f6783acdc378f743fcdd2a

  - name: hdf5
    cleanup: 
      - /share/hdf5_examples
    sources:
      - type: archive
        url: https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.12/hdf5-1.12.0/src/hdf5-1.12.0.tar.gz
        sha256: a62dcb276658cb78e6795dd29bf926ed7a9bc4edf6e77025cd2c689a8f97c17a
        
  - name: python-h5py
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: git
        url: https://github.com/h5py/h5py
        tag: 3.2.1
        commit: 7f918857e2a63477038afccda518ebd3159c13b2
      - type: patch
        path: python-h5py-relax-dependency-versions.patch

  - name: sip
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/33/e9/27730ac17713c0a80d81d8f3bb56213f1549d96f9dc183fd16a7eec6287c/sip-5.5.0.tar.gz
        sha256: 5d024c419b30fea8a6de8c71a560c7ab0bc3c221fbfb14d55a5b865bd58eaac5

  - name: PyQt5_sip
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/b1/40/dd8f081f04a12912b65417979bf2097def0af0f20c89083ada3670562ac5/PyQt5_sip-12.9.0.tar.gz
        sha256: d3e4489d7c2b0ece9d203ae66e573939f7f60d4d29e089c9f11daa17cfeaae32
 
  - name: PyQt5
    buildsystem: simple
    build-commands:
      - PYVER=$(python3 -c "import sys;print(sys.version_info[1])") &&
        QMAKEPATH=/app/lib python3 configure.py
        --confirm-license
        --bindir=/app/bin
        --destdir=/app/lib/python3.${PYVER}/site-packages
        --designer-plugindir=/app/lib/plugins/designer
        --qml-plugindir=/app/lib/plugins/PyQt5
        --sipdir=/app/share/sip
        --stubsdir=/app/lib/python3.${PYVER}/site-packages/PyQt5
        --disable=QtBluetooth 
        --disable=QtWebKit 
        --disable=QtWebKitWidgets 
        --disable=QtNfc 
        --disable=QtPositioning
        --disable=QtNetwork
        --disable=QtTextToSpeech
        --disable=QtMultimediaWidgets 
        --disable=QtLocation 
        --disable=QtDesigner
        --disable=QtSensors 
        --disable=QtWebEngine 
        --disable=QtQuick 
        --disable=QtQml 
        --disable=QtTest 
      - make -j $FLATPAK_BUILDER_N_JOBS
      - make install
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/8e/a4/d5e4bf99dd50134c88b95e926d7b81aad2473b47fde5e3e4eac2c69a8942/PyQt5-5.15.4.tar.gz
        sha256: 2a69597e0dd11caabe75fae133feca66387819fc9bc050f547e5551bce97e5be
      
  - name: ghostscript
    config-opts:
      - --enable-dynamic
      - --disable-cups
      - --disable-dbus
      - --disable-gtk
      - --with-drivers=FILES
# https://github.com/flathub/flathub/pull/825#issuecomment-457206134
# https://flathub.org/builds/#/builders/36/builds/687
# https://github.com/imagemin/optipng-bin/issues/97#issue-317622868
# https://discourse.libsdl.org/t/ndk-sdl2-image-libpng-build-error-png-init-filter-functions-neon/24947/3
    build-options:
      arch:
        aarch64:
          cppflags: -DPNG_ARM_NEON_OPT=0
    sources:
      - type: archive
        url: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9540/ghostscript-9.54.0.tar.gz
        sha256: 0646bb97f6f4d10a763f4919c54fa28b4fbdd3dff8e7de3410431c81762cade0
    cleanup:
       - /share/doc
       
  - name: python-astropy
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/4e/a6/4a1576e4a51b10b4b7440cbd36fc3c71fb69fb634672ce0725de614182ca/astropy-4.2.1.tar.gz
        sha256: ed483e472241153daec45f4b0c318c2c63d9f47305b78e6e63d32fc388c18427
    modules:
      - name: python-setuptools-scm
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/57/38/930b1241372a9f266a7df2b184fb9d4f497c2cef2e016b014f82f541fe7c/setuptools_scm-6.0.1.tar.gz
            sha256: d1925a69cb07e9b29416a275b9fadb009a23c148ace905b2fb220649a6c18e92
      - name: python-extension-helpers
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/81/78/056daee475dfc41cc0b62540388703cddcae4d4f6bef10c6ce1aea76ebaf/extension-helpers-0.1.tar.gz
            sha256: ac8a6fe91c6d98986a51a9f08ca0c7945f8fd70d95b662ced4040ae5eb973882
      - name: python-jinja2
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/4f/e7/65300e6b32e69768ded990494809106f87da1d436418d5f1367ed3966fd7/Jinja2-2.11.3.tar.gz
            sha256: a6d58433de0ae800347cab1fa3043cebbabe8baa9d29e668f1c768cb87a333c6
      - name: python-MarkupSafe
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/b9/2e/64db92e53b86efccfaea71321f597fa2e1b2bd3853d8ce658568f7a13094/MarkupSafe-1.1.1.tar.gz
            sha256: 29872e92839765e546828bb7754a68c418d927cd064fd4708fab9fe9c8bb116b
      - name: python-packaging
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/86/3c/bcd09ec5df7123abcf695009221a52f90438d877a2f1499453c6938f5728/packaging-20.9.tar.gz
            sha256: 5b327ac1320dc863dca72f4514ecc086f31186744b84a230374cc1fd776feae5
      - name: python-pyerfa
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/e3/af/ae39c2b1f652895238888f186579b7eedb9f55fdbde78ad75f34597059bc/pyerfa-1.7.2.tar.gz
            sha256: 31776213ec36e6bb5382b526be02e417b8697d791c6837199342c19e7dabe8e8
        
  - name: python-pyemf
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: git
        url: https://github.com/jeremysanders/pyemf
        tag: master
        commit: 830e61008af8acf1830e5c91dc876313a771afdb
        
  - name: python-dbus-python
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/62/7e/d4fb56a1695fa65da0c8d3071855fa5408447b913c58c01933c2f81a269a/dbus-python-1.2.16.tar.gz
        sha256: 11238f1d86c995d8aed2e22f04a1e3779f0d70e587caffeab4857f3c662ed5a4
        
  - name: python-iminuit
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: git
        url: https://github.com/scikit-hep/iminuit
        tag: v2.4.0
        # Fix pybind11 cannot find python3 from u/tinywrkb
      - type: patch
        path: pybind11_include_dirs.patch

  - name: Veusz
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py build_ext --sip-dir=/app/share/sip
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
      - install -Dm644 icons/veusz.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/veusz.svg
      - install -Dm644 icons/veusz_128.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/veusz.png
      - install -Dm644 support/veusz.appdata.xml ${FLATPAK_DEST}/share/appdata/${FLATPAK_ID}.appdata.xml
      - install -Dm644 support/veusz.desktop ${FLATPAK_DEST}/share/applications/veusz.desktop
      - desktop-file-edit --set-key=Icon --set-value=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/veusz.desktop
    sources:
      - type: git
        url: https://github.com/veusz/veusz
        tag: veusz-3.3.1
        commit: 5ea57fe18b1470873758df0223694131475b9758
      - type: patch
        path: fix_appdata.patch
        # Veusz expect SIP to be under PyQt5 subdirectory, but I don't know why I have different dir structure.
        #https://github.com/veusz/veusz/issues/307
      - type: patch
        path: fix_sip_dir.patch


 
