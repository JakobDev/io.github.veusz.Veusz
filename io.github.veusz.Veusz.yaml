app-id: io.github.veusz.Veusz
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
command: veusz
separate-locales: false
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri

modules:
  - name: python3-numpy
    buildsystem: simple
    build-commands:
      - rm pyproject.toml
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: git
        url: https://github.com/numpy/numpy
        tag: v1.20.2
        commit: b19ad5bfa396a4600a52a598a30a65d4e993f831

  - name: hdf5
    cleanup: 
      - /share/hdf5_examples
    sources:
      - type: archive
        url: https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.12/hdf5-1.12.0/src/hdf5-1.12.0.tar.gz
        sha256: a62dcb276658cb78e6795dd29bf926ed7a9bc4edf6e77025cd2c689a8f97c17a
        
  - name: python-pkgconfig
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/ae/61/5a76ead90f9a62212c231b05231031e750f24e4dd2401d8c7f3f0527821b/pkgconfig-1.5.2.tar.gz
        sha256: 38d612488f0633755a2e7a8acab6c01d20d63dbc31af75e2a9ac98a6f638ca94
        
  - name: python-h5py
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: git
        url: https://github.com/h5py/h5py
        tag: 3.2.1
        commit: 7f918857e2a63477038afccda518ebd3159c13b2
      - type: patch
        path: python-h5py-relax-dependency-versions.patch

  - name: python3-sip
    config-opts:
      - --sip-module=PyQt5.sip
      - --bindir=/app/bin
      - --destdir=/app/lib/python3.8/site-packages
      - --incdir=/app/include
    sources:
      - type: archive
        url: https://sourceforge.net/projects/pyqt/files/sip/sip-4.19.13/sip-4.19.13.tar.gz
        sha256: e353a7056599bf5fbd5d3ff9842a6ab2ea3cf4e0304a0f925ec5862907c0d15e
        #url: https://www.riverbankcomputing.com/static/Downloads/sip/4.19.25/sip-4.19.25.tar.gz
        #sha256: e353a7056599bf5fbd5d3ff9842a6ab2ea3cf4e0304a0f925ec5862907c0d15e
  # Patch50
  # make install should not strip (by default)
      - type: patch
        path: sip-4.18-no_strip.patch
  #Patch51
  #try not to rpath the world
      - type: patch
        path: sip-4.18-no_rpath.patch
      - type: script
        commands:
          - processed="$( sed -e 's|--prefix=/app||' <<< "${@}" )";
          - python3 "configure.py" ${processed};
        dest-filename: configure
    cleanup:
      - /bin
 
  - name: python3-qt5
    config-opts:
      - --verbose
      - --confirm-license
      - --sip-incdir=/app//include
      - --bindir=/app//bin
      - --destdir=/app//lib/python3.8/site-packages
      - --designer-plugindir=/app//lib/plugins/designer
      - --qml-plugindir=/app//lib/plugins/PyQt5
      - QMAKE_CFLAGS_RELEASE=-I/usr/include/python3.8/
      - QMAKE_CXXFLAGS_RELEASE=-I/usr/include/python3.8/
    build-options:
      env:
        QMAKEPATH: "/app/lib"
    sources:
      - type: archive
        url: https://sourceforge.net/projects/pyqt/files/PyQt5/PyQt-5.11.3/PyQt5_gpl-5.11.3.tar.gz
        sha256: c9b57d15601d436faf35dacf8e0acefa220194829a653e771e80b189b3261073
        #url: https://files.pythonhosted.org/packages/8e/a4/d5e4bf99dd50134c88b95e926d7b81aad2473b47fde5e3e4eac2c69a8942/PyQt5-5.15.4.tar.gz
        #sha256: c9b57d15601d436faf35dacf8e0acefa220194829a653e771e80b189b3261073
        
  #Patch1
  #support newer Qt5 releases than 5.11.2
      - type: patch
        path: PyQt5-Timeline.patch
      - type: script
        commands:
           - processed="$( sed -e 's|prefix|sysroot|' <<< "${@}" )";
           - python3 "configure.py" ${processed};
        dest-filename: configure
    cleanup:
      - /bin
      
  #- name: python3-sip
    #buildsystem: simple
    #build-commands:
      #- python3 setup.py build
      #- python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    #sources:
      #- type: archive
        #url: https://files.pythonhosted.org/packages/33/e9/27730ac17713c0a80d81d8f3bb56213f1549d96f9dc183fd16a7eec6287c/sip-5.5.0.tar.gz
        #sha256: 5d024c419b30fea8a6de8c71a560c7ab0bc3c221fbfb14d55a5b865bd58eaac5
    #modules:
      #- name: python3-toml
        #buildsystem: simple
        #build-commands:
          #- python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        #sources:
          #- type: archive
            #url: https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz
            #sha256: b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f
      #- name: python3-packaging
        #buildsystem: simple
        #build-commands:
          #- python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        #sources:
          #- type: archive
            #url: https://files.pythonhosted.org/packages/d7/c5/e81b9fb8033fe78a2355ea7b1774338e1dca2c9cbd2ee140211a9e6291ab/packaging-20.8.tar.gz
            #sha256: 78598185a7008a470d64526a8059de9aaa449238f280fc9eb6b13ba6c4109093
      #- name: python3-pyparsing
        #buildsystem: simple
        #build-commands:
          #- python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        #sources:
         #- type: archive
           #url: https://files.pythonhosted.org/packages/c1/47/dfc9c342c9842bbe0036c7f763d2d6686bcf5eb1808ba3e170afdb282210/pyparsing-2.4.7.tar.gz
           #sha256: c203ec8783bf771a155b207279b9bccb8dea02d8f0c9e5f8ead507bc3246ecc1
           
    ## Shamelessly taken from io.github.ciromattia.kcc  
  #- name: pyqt5
    #buildsystem: simple
    #build-commands:
      #- PY_VER=python$(python3 -c 'import sys; print(sys.version[:3])') &&
        #python3 configure.py
          #--confirm-license
          #--assume-shared
          #--destdir=${FLATPAK_DEST}/lib/${PY_VER}/site-packages
          #--sip-incdir=${FLATPAK_DEST}/include
          #--no-designer-plugin
          #--no-qml-plugin
          #--no-python-dbus
          #--no-tools
          #${config_opt}
      #- make -j $FLATPAK_BUILDER_N_JOBS
      #- make install
    #cleanup:
      #- /bin
    #sources:
      #- type: archive
        #url: https://files.pythonhosted.org/packages/source/p/pyqt5/PyQt5-5.15.2.tar.gz
        #sha256: 372b08dc9321d1201e4690182697c5e7ffb2e0770e6b4a45519025134b12e4fc 
        
  - name: Veusz
    buildsystem: simple
    ensure-writable:
      - /lib/python3.8/site-packages/easy-install.pth
    build-commands:
      - python3 setup.py build_ext --sip-dir=/app/share/sip
      - python3 setup.py install --prefix=/app
      - install -Dm644 "support/veusz.appdata.xml" "${FLATPAK_DEST}/share${FLATPAK_DEST}data/$FLATPAK_ID.appdata.xml"
    sources:
      - type: git
        url: https://github.com/veusz/veusz
        tag: veusz-3.3.1
        commit: 5ea57fe18b1470873758df0223694131475b9758
      - type: patch
        path: fix_appdata.patch


